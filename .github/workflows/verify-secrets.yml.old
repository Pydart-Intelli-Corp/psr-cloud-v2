name: Verify GitHub Secrets

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  verify-secrets:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Required Secrets
        run: |
          echo "ğŸ” Verifying GitHub Secrets Configuration..."
          echo ""
          
          MISSING_SECRETS=0
          
          # Check VPS_HOST
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "âŒ VPS_HOST is not set"
            MISSING_SECRETS=$((MISSING_SECRETS + 1))
          else
            echo "âœ… VPS_HOST is configured"
          fi
          
          # Check VPS_USERNAME
          if [ -z "${{ secrets.VPS_USERNAME }}" ]; then
            echo "âŒ VPS_USERNAME is not set"
            MISSING_SECRETS=$((MISSING_SECRETS + 1))
          else
            echo "âœ… VPS_USERNAME is configured"
          fi
          
          # Check VPS_PASSWORD
          if [ -z "${{ secrets.VPS_PASSWORD }}" ]; then
            echo "âŒ VPS_PASSWORD is not set"
            MISSING_SECRETS=$((MISSING_SECRETS + 1))
          else
            echo "âœ… VPS_PASSWORD is configured"
          fi
          
          # Check EMAIL_USER
          if [ -z "${{ secrets.EMAIL_USER }}" ]; then
            echo "âŒ EMAIL_USER is not set"
            MISSING_SECRETS=$((MISSING_SECRETS + 1))
          else
            echo "âœ… EMAIL_USER is configured"
          fi
          
          # Check EMAIL_PASSWORD
          if [ -z "${{ secrets.EMAIL_PASSWORD }}" ]; then
            echo "âŒ EMAIL_PASSWORD is not set"
            MISSING_SECRETS=$((MISSING_SECRETS + 1))
          else
            echo "âœ… EMAIL_PASSWORD is configured"
          fi
          
          echo ""
          echo "=========================================="
          
          if [ $MISSING_SECRETS -eq 0 ]; then
            echo "âœ… All required secrets are configured!"
            echo "=========================================="
            echo ""
            echo "You can now run the 'Setup VPS Environment' workflow."
            echo ""
            echo "Next steps:"
            echo "  1. Go to Actions tab"
            echo "  2. Select 'Setup VPS Environment'"
            echo "  3. Click 'Run workflow'"
            echo "  4. (Optional) Enter domain and email for SSL"
            echo "  5. Click green 'Run workflow' button"
            exit 0
          else
            echo "âŒ Missing $MISSING_SECRETS secret(s)"
            echo "=========================================="
            echo ""
            echo "Please add the missing secrets at:"
            echo "https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo ""
            echo "Required secrets:"
            echo "  1. VPS_HOST        - Your VPS IP address (e.g., 168.231.121.19)"
            echo "  2. VPS_USERNAME    - SSH username (e.g., root)"
            echo "  3. VPS_PASSWORD    - SSH password"
            echo "  4. EMAIL_USER      - Gmail address for sending emails"
            echo "  5. EMAIL_PASSWORD  - Gmail app password"
            echo ""
            echo "For detailed instructions, see: docs/GITHUB_SECRETS_SETUP.md"
            exit 1
          fi

      - name: Test VPS Connectivity (Optional)
        if: success()
        continue-on-error: true
        run: |
          echo ""
          echo "ğŸ”Œ Testing VPS connectivity..."
          
          # Try to ping the VPS
          if ping -c 3 "${{ secrets.VPS_HOST }}" > /dev/null 2>&1; then
            echo "âœ… VPS is reachable at ${{ secrets.VPS_HOST }}"
          else
            echo "âš ï¸  Warning: Cannot ping VPS (this may be normal if ICMP is blocked)"
            echo "   The VPS may still be accessible via SSH"
          fi
          
          # Try to check if SSH port is open
          if timeout 5 bash -c "cat < /dev/null > /dev/tcp/${{ secrets.VPS_HOST }}/22" 2>/dev/null; then
            echo "âœ… SSH port (22) is open on VPS"
          else
            echo "âš ï¸  Warning: SSH port appears closed or filtered"
            echo "   Please verify your VPS is running and SSH is enabled"
          fi

      - name: Display Next Steps
        if: success()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                              â•‘"
          echo "â•‘     âœ… READY FOR VPS SETUP!                 â•‘"
          echo "â•‘                                              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "All secrets are configured correctly."
          echo ""
          echo "ğŸ“‹ Next Action:"
          echo "  Run the 'Setup VPS Environment' workflow"
          echo ""
          echo "ğŸ“– Documentation:"
          echo "  Quick Start: QUICKSTART.md"
          echo "  Full Guide:  docs/VPS_AUTO_SETUP.md"
          echo ""
