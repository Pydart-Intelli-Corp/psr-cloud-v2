name: Deploy to VPS

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          REPO_URL: ${{ github.repository }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT || '3306' }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
          SUPER_ADMIN_USERNAME: ${{ secrets.SUPER_ADMIN_USERNAME || 'admin' }}
          SUPER_ADMIN_PASSWORD: ${{ secrets.SUPER_ADMIN_PASSWORD || 'psr@2025' }}
          SUPER_ADMIN_EMAIL: ${{ secrets.SUPER_ADMIN_EMAIL || 'admin@poornasreeequipments.com' }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          envs: GITHUB_TOKEN,REPO_URL,VPS_HOST,EMAIL_USER,EMAIL_PASSWORD,DB_HOST,DB_PORT,DB_USER,DB_PASSWORD,DB_NAME,JWT_SECRET,JWT_REFRESH_SECRET,SUPER_ADMIN_USERNAME,SUPER_ADMIN_PASSWORD,SUPER_ADMIN_EMAIL
          script: |
            set -e
            
            cd /var/www/psr-v4
            
            # Backup .env.production if it exists
            if [ -f ".env.production" ]; then
              echo "ðŸ’¾ Backing up .env.production..."
              cp .env.production /tmp/.env.production.backup
            fi
            
            # Update git remote and pull latest changes
            if [ -d ".git" ]; then
              git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${REPO_URL}.git
            else
              git init
              git config credential.helper store
              echo "https://x-access-token:${GITHUB_TOKEN}@github.com" > ~/.git-credentials
              git remote add origin https://github.com/${REPO_URL}.git
            fi
            
            echo "ðŸ“¥ Pulling latest changes from GitHub..."
            git fetch origin
            git reset --hard origin/master
            
            # Restore or create .env.production
            if [ -f "/tmp/.env.production.backup" ]; then
              echo "â™»ï¸  Restoring .env.production..."
              cp /tmp/.env.production.backup .env.production
            else
              echo "ðŸ“ Creating .env.production..."
              cat > .env.production << ENV_EOF
            # Database Configuration
            DB_HOST=${DB_HOST}
            DB_PORT=${DB_PORT}
            DB_USER=${DB_USER}
            DB_PASSWORD=${DB_PASSWORD}
            DB_NAME=${DB_NAME}
            DB_SSL_CA=
            DB_REJECT_UNAUTHORIZED=false
            
            # Application
            NODE_ENV=production
            PORT=3000
            NEXT_TELEMETRY_DISABLED=1
            
            # JWT Secrets
            JWT_SECRET=${JWT_SECRET}
            JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
            JWT_EXPIRES_IN=1h
            JWT_REFRESH_EXPIRES_IN=7d
            
            # Super Admin Credentials
            SUPER_ADMIN_USERNAME=${SUPER_ADMIN_USERNAME}
            SUPER_ADMIN_PASSWORD=${SUPER_ADMIN_PASSWORD}
            SUPER_ADMIN_EMAIL=${SUPER_ADMIN_EMAIL}
            
            # Email Configuration
            SMTP_HOST=smtp.gmail.com
            SMTP_PORT=587
            SMTP_SECURE=false
            SMTP_USERNAME=${EMAIL_USER}
            SMTP_PASSWORD=${EMAIL_PASSWORD}
            EMAIL_HOST=smtp.gmail.com
            EMAIL_PORT=587
            EMAIL_SECURE=false
            EMAIL_USER=${EMAIL_USER}
            EMAIL_PASSWORD=${EMAIL_PASSWORD}
            EMAIL_FROM=noreply@poornasreeequipments.com
            
            # Application URLs
            NEXT_PUBLIC_API_URL=http://${VPS_HOST}
            NEXT_PUBLIC_APP_URL=http://${VPS_HOST}
            ENV_EOF
            fi
            
            # Stop PM2 to release file locks
            echo "ðŸ›‘ Stopping PM2..."
            pm2 stop psr-v4 || true
            
            # Clean old node_modules to free memory
            echo "ðŸ§¹ Cleaning old modules..."
            rm -rf node_modules
            
            # Install dependencies (npm ci is more memory efficient)
            echo "ðŸ“¦ Installing dependencies..."
            npm ci --production
            
            # Build application on VPS where .env.production exists
            echo "ðŸ—ï¸ Building application..."
            NODE_OPTIONS="--max-old-space-size=2048" npm run build
            
            # Run database migrations
            echo "ðŸ—„ï¸ Running database migrations..."
            npx sequelize-cli db:migrate --env production || true
            npx sequelize-cli db:seed:all --env production || true
            
            # Fix file ownership
            echo "ðŸ” Fixing file ownership..."
            chown -R root:root /var/www/psr-v4
            
            # Restart PM2
            echo "ðŸš€ Starting PM2..."
            pm2 delete psr-v4 || true
            pm2 start npm --name psr-v4 -- start
            pm2 save
            
            echo "ðŸ“Š PM2 Status:"
            pm2 status
            
            echo "âœ… Deployment completed successfully!"
