name: Deploy to VPS

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '21.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Create deployment archive
        run: |
          mkdir -p deploy
          
          echo "ðŸ“¦ Preparing deployment files..."
          # Copy .next build (exclude cache and traces)
          mkdir -p deploy/.next
          rsync -av --exclude='cache' --exclude='trace' --exclude='*.map' .next/ deploy/.next/ || cp -r .next deploy/
          
          # Copy essential files only
          cp -r public deploy/ 2>/dev/null || true
          cp -r database deploy/ 2>/dev/null || true
          cp -r config deploy/ 2>/dev/null || true
          cp package*.json deploy/
          cp next.config.ts tsconfig.json postcss.config.mjs tailwind.config.js instrumentation.ts ecosystem.config.js deploy/ 2>/dev/null || true
          
          echo "ðŸ“Š Deployment size before compression:"
          du -sh deploy/
          du -sh deploy/.next/ 2>/dev/null || true
          
          # Create optimized archive
          tar -czf deploy.tar.gz -C deploy .
          
          echo "ðŸ“¦ Final archive size:"
          ls -lh deploy.tar.gz
          echo "âœ… Archive created successfully"

      - name: Upload to VPS via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          source: "deploy.tar.gz"
          target: "/tmp/"
          overwrite: true
          timeout: 10m
          command_timeout: 10m
          
      - name: Verify Upload
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          script: |
            if [ -f /tmp/deploy.tar.gz ]; then
              echo "âœ… Upload successful!"
              ls -lh /tmp/deploy.tar.gz
            else
              echo "âŒ Upload failed - file not found"
              ls -lah /tmp/ | head -20
              exit 1
            fi

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          REPO_URL: ${{ github.repository }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT || '3306' }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          JWT_SECRET: ${{ secrets.JWT_SECRET || 'psr-production-jwt-secret-2025-minimum-32-characters-long' }}
          JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET || 'psr-production-refresh-secret-2025-minimum-32-chars' }}
          SUPER_ADMIN_USERNAME: ${{ secrets.SUPER_ADMIN_USERNAME || 'superadmin' }}
          SUPER_ADMIN_PASSWORD: ${{ secrets.SUPER_ADMIN_PASSWORD || 'psr$20252' }}
          SUPER_ADMIN_EMAIL: ${{ secrets.SUPER_ADMIN_EMAIL || 'rndpoornasree@gmail.com' }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          envs: GITHUB_TOKEN,REPO_URL,VPS_HOST,EMAIL_USER,EMAIL_PASSWORD,DB_HOST,DB_PORT,DB_USER,DB_PASSWORD,DB_NAME,JWT_SECRET,JWT_REFRESH_SECRET,SUPER_ADMIN_USERNAME,SUPER_ADMIN_PASSWORD,SUPER_ADMIN_EMAIL
          script: |
            set -e
            cd /var/www/psr-v4
            
            # Verify archive exists
            if [ ! -f /tmp/deploy.tar.gz ]; then
              echo "âŒ ERROR: Archive not found at /tmp/deploy.tar.gz"
              echo "ðŸ“‚ Contents of /tmp:"
              ls -lah /tmp/ | grep deploy || echo "No deploy files found"
              exit 1
            fi
            
            echo "ðŸ“¦ Archive size: $(du -h /tmp/deploy.tar.gz | cut -f1)"
            echo "ðŸ’¾ Available memory: $(free -h | awk '/^Mem:/ {print $7}')"
            echo "ðŸ’¿ Available disk: $(df -h /var/www/psr-v4 | tail -1 | awk '{print $4}')"
            
            echo "ðŸ§¹ Cleaning old build files..."
            rm -rf .next/cache 2>/dev/null || true
            
            echo "ðŸ”„ Extracting deployment archive..."
            # Test archive integrity first
            if ! tar -tzf /tmp/deploy.tar.gz > /dev/null 2>&1; then
              echo "âŒ Archive is corrupted or incomplete"
              exit 1
            fi
            
            # Extract with lower memory usage
            tar -xzf /tmp/deploy.tar.gz -C /var/www/psr-v4
            rm /tmp/deploy.tar.gz
            
            echo "âœ… Extraction completed successfully"
            
            echo "ðŸ“ Creating .env.production..."
            cat > .env.production << ENV_EOF
            DB_HOST=${DB_HOST}
            DB_PORT=${DB_PORT}
            DB_USER=${DB_USER}
            DB_PASSWORD=${DB_PASSWORD}
            DB_NAME=${DB_NAME}
            DB_SSL_CA=
            DB_REJECT_UNAUTHORIZED=false
            NODE_ENV=production
            PORT=3000
            NEXT_TELEMETRY_DISABLED=1
            JWT_SECRET=${JWT_SECRET}
            JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
            JWT_EXPIRES_IN=1h
            JWT_REFRESH_EXPIRES_IN=7d
            SUPER_ADMIN_USERNAME=${SUPER_ADMIN_USERNAME}
            SUPER_ADMIN_PASSWORD=${SUPER_ADMIN_PASSWORD}
            SUPER_ADMIN_EMAIL=${SUPER_ADMIN_EMAIL}
            SMTP_HOST=smtp.gmail.com
            SMTP_PORT=587
            SMTP_SECURE=false
            SMTP_USERNAME=${EMAIL_USER}
            SMTP_PASSWORD=${EMAIL_PASSWORD}
            EMAIL_HOST=smtp.gmail.com
            EMAIL_PORT=587
            EMAIL_SECURE=false
            EMAIL_USER=${EMAIL_USER}
            EMAIL_PASSWORD=${EMAIL_PASSWORD}
            EMAIL_FROM=noreply@poornasreeequipments.com
            NEXT_PUBLIC_API_URL=https://v4.poornasreecloud.com
            NEXT_PUBLIC_APP_URL=https://v4.poornasreecloud.com
            ENV_EOF
            

            echo "ðŸ” Fixing file ownership..."
            chown -R root:root /var/www/psr-v4
            
            echo "ðŸš€ Starting/Reloading PM2..."
            if pm2 list | grep -q psr-v4; then
              pm2 reload psr-v4 --update-env
            else
              pm2 start npm --name psr-v4 -- start
              pm2 save
            fi
            
            echo "ðŸ“Š PM2 Status:"
            pm2 status
            
            echo "âœ… Deployment completed!"
