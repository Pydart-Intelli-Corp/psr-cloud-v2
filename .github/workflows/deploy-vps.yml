name: Deploy to VPS

on:
  push:
    branches:
      - master
  workflow_dispatch:  # Allows manual deployment

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Verify Required Secrets
        run: |
          if [ -z "${{ secrets.VPS_HOST }}" ] || [ -z "${{ secrets.VPS_USERNAME }}" ] || [ -z "${{ secrets.VPS_PASSWORD }}" ]; then
            echo "‚ùå ERROR: Required VPS secrets are not configured!"
            echo ""
            echo "Please add the following secrets to your repository:"
            echo "  1. VPS_HOST - Your VPS IP address"
            echo "  2. VPS_USERNAME - SSH username"
            echo "  3. VPS_PASSWORD - SSH password"
            echo ""
            echo "Add secrets at: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo ""
            echo "For help, see: docs/GITHUB_SECRETS_SETUP.md or QUICKSTART.md"
            exit 1
          fi
          if [ -z "${{ secrets.DB_HOST }}" ] || [ -z "${{ secrets.DB_USER }}" ] || [ -z "${{ secrets.DB_PASSWORD }}" ] || [ -z "${{ secrets.DB_NAME }}" ]; then
            echo "‚ö†Ô∏è  WARNING: Database secrets not fully configured!"
            echo "Using default database configuration."
            echo "For custom database, add these secrets:"
            echo "  - DB_HOST (default: localhost)"
            echo "  - DB_USER (default: psr_admin)"
            echo "  - DB_PASSWORD (default: PsrAdmin@20252!)"
            echo "  - DB_NAME (default: psr_v4_main)"
            echo ""
          fi
          if [ -z "${{ secrets.EMAIL_USER }}" ] || [ -z "${{ secrets.EMAIL_PASSWORD }}" ]; then
            echo "‚ö†Ô∏è  WARNING: Email secrets not configured!"
            echo "Email functionality will not work without these secrets."
            echo "Add EMAIL_USER and EMAIL_PASSWORD secrets if needed."
          fi
          if [ -z "${{ secrets.GH_PAT }}" ]; then
            echo "‚ö†Ô∏è  WARNING: GH_PAT secret not configured!"
            echo "The built-in GITHUB_TOKEN will be used for git operations."
            echo "If deployment fails, create a Personal Access Token and add it as GH_PAT secret."
            echo ""
          fi
          echo "‚úÖ Required secrets are configured"
      
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '21.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          REPO_URL: ${{ github.repository }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          DB_HOST: ${{ secrets.DB_HOST || 'localhost' }}
          DB_PORT: ${{ secrets.DB_PORT || '3306' }}
          DB_USER: ${{ secrets.DB_USER || 'psr_admin' }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD || 'PsrAdmin@20252!' }}
          DB_NAME: ${{ secrets.DB_NAME || 'psr_v4_main' }}
          SUPER_ADMIN_USERNAME: ${{ secrets.SUPER_ADMIN_USERNAME || 'admin' }}
          SUPER_ADMIN_PASSWORD: ${{ secrets.SUPER_ADMIN_PASSWORD || 'psr@2025' }}
          SUPER_ADMIN_EMAIL: ${{ secrets.SUPER_ADMIN_EMAIL || 'admin@poornasreeequipments.com' }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          envs: GITHUB_TOKEN,REPO_URL,VPS_HOST,EMAIL_USER,EMAIL_PASSWORD,DB_HOST,DB_PORT,DB_USER,DB_PASSWORD,DB_NAME,SUPER_ADMIN_USERNAME,SUPER_ADMIN_PASSWORD,SUPER_ADMIN_EMAIL
          script: |
            set -e
            
            # Check if initial setup has been completed
            if [ ! -d "/var/www/psr-v4" ]; then
              echo "‚ùå ERROR: VPS has not been set up yet!"
              echo ""
              echo "The directory /var/www/psr-v4 does not exist."
              echo "This means you haven't run the initial VPS setup."
              echo ""
              echo "üìã REQUIRED ACTION:"
              echo "  1. Go to: https://github.com/$GITHUB_REPOSITORY/actions"
              echo "  2. Select 'Setup VPS Environment' workflow"
              echo "  3. Click 'Run workflow'"
              echo "  4. Wait ~10 minutes for completion"
              echo ""
              echo "After setup completes, deployments will work automatically."
              echo ""
              echo "See: QUICKSTART.md or ADD_SECRETS_NOW.md for details"
              exit 1
            fi
            
            # Navigate to application directory
            cd /var/www/psr-v4
            
            # Backup .env.production if it exists
            if [ -f ".env.production" ]; then
              echo "üíæ Backing up .env.production..."
              cp .env.production /tmp/.env.production.backup
            fi
            
            # Check if git repository exists
            if [ ! -d ".git" ]; then
              echo "‚ö†Ô∏è  Git repository not initialized. Initializing..."
              
              # Backup existing files if any
              if [ "$(ls -A)" ]; then
                echo "üì¶ Backing up existing files..."
                mkdir -p /tmp/psr-v4-backup
                cp -r * /tmp/psr-v4-backup/ 2>/dev/null || true
                cp -r .* /tmp/psr-v4-backup/ 2>/dev/null || true
              fi
              
              # Initialize git and pull from remote with authentication
              git init
              git config credential.helper store
              echo "https://x-access-token:${GITHUB_TOKEN}@github.com" > ~/.git-credentials
              git remote add origin https://github.com/${REPO_URL}.git
              git fetch origin
              git reset --hard origin/master
              
              echo "‚úÖ Repository initialized successfully"
            else
              # Update remote URL to use token authentication
              git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${REPO_URL}.git
            fi
            
            # Pull latest changes
            echo "üì• Pulling latest changes from GitHub..."
            git fetch origin
            git reset --hard origin/master
            
            # Restore or create .env.production
            if [ -f "/tmp/.env.production.backup" ]; then
              echo "‚ôªÔ∏è  Restoring .env.production..."
              cp /tmp/.env.production.backup .env.production
            else
              echo "‚ö†Ô∏è  .env.production not found - creating new one..."
              
              # Generate JWT secrets
              JWT_SECRET=$(openssl rand -hex 64)
              JWT_REFRESH_SECRET=$(openssl rand -hex 64)
              
              # Create .env.production with variable substitution
              cat > .env.production << ENV_EOF
            # Database Configuration
            DB_HOST=${DB_HOST}
            DB_PORT=${DB_PORT}
            DB_USER=${DB_USER}
            DB_PASSWORD=${DB_PASSWORD}
            DB_NAME=${DB_NAME}
            DB_SSL_CA=
            DB_REJECT_UNAUTHORIZED=false
            
            # Application
            NODE_ENV=production
            PORT=3000
            NEXT_TELEMETRY_DISABLED=1
            
            # JWT Secrets (Auto-generated)
            JWT_SECRET=${JWT_SECRET}
            JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
            JWT_EXPIRES_IN=1h
            JWT_REFRESH_EXPIRES_IN=7d
            
            # Super Admin Credentials
            SUPER_ADMIN_USERNAME=${SUPER_ADMIN_USERNAME}
            SUPER_ADMIN_PASSWORD=${SUPER_ADMIN_PASSWORD}
            SUPER_ADMIN_EMAIL=${SUPER_ADMIN_EMAIL}
            
            # Email Configuration
            EMAIL_HOST=smtp.gmail.com
            EMAIL_PORT=587
            EMAIL_SECURE=false
            EMAIL_USER=${EMAIL_USER}
            EMAIL_PASSWORD=${EMAIL_PASSWORD}
            EMAIL_FROM=noreply@poornasreeequipments.com
            
            # Application URLs
            NEXT_PUBLIC_API_URL=http://${VPS_HOST}
            NEXT_PUBLIC_APP_URL=http://${VPS_HOST}
            ENV_EOF
              
              echo "‚úÖ Created .env.production with:"
              echo "   - Database: ${DB_USER}@${DB_HOST}:${DB_PORT}/${DB_NAME}"
              echo "   - Email: ${EMAIL_USER:-'Not configured'}"
              echo "   - API URL: http://${VPS_HOST}"
              echo "   - Auto-generated JWT secrets"
            fi
            
            # Install dependencies
            echo "üì¶ Installing dependencies..."
            npm ci --production
            
            # Build application
            echo "üî® Building application..."
            npm run build
            
            # Run database migrations
            echo "üóÑÔ∏è Running database migrations..."
            
            # Check if database needs initialization
            TABLE_COUNT=$(mysql -h ${DB_HOST} -P ${DB_PORT} -u ${DB_USER} -p${DB_PASSWORD} ${DB_NAME} -e "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = '${DB_NAME}';" -ss 2>/dev/null || echo "0")
            
            if [ "$TABLE_COUNT" = "0" ]; then
              echo "üìä Database is empty - running all migrations from scratch..."
              npx sequelize-cli db:migrate --env production
              
              echo "üå± Running database seeders..."
              npx sequelize-cli db:seed:all --env production
              echo "‚úÖ Super admin created: admin@poornasreeequipments.com / psr@2025"
            else
              echo "üìä Database has ${TABLE_COUNT} tables - running pending migrations..."
              npx sequelize-cli db:migrate --env production
              
              # Check if super admin exists
              ADMIN_EXISTS=$(mysql -h ${DB_HOST} -P ${DB_PORT} -u ${DB_USER} -p${DB_PASSWORD} ${DB_NAME} -e "SELECT COUNT(*) FROM users WHERE role = 'super_admin' AND email = 'admin@poornasreeequipments.com';" -ss 2>/dev/null || echo "0")
              
              if [ "$ADMIN_EXISTS" = "0" ]; then
                echo "üå± Super admin not found - running seeders..."
                npx sequelize-cli db:seed:all --env production
                echo "‚úÖ Super admin created: admin@poornasreeequipments.com / psr@2025"
              else
                echo "‚úÖ Super admin already exists"
              fi
            fi
            
            # Reload Nginx if configuration changed
            echo "üîÑ Reloading Nginx..."
            nginx -t && systemctl reload nginx || echo "Nginx reload skipped"
            
            # Restart application with PM2
            echo "üîÑ Restarting application..."
            pm2 restart psr-v4 || pm2 start npm --name "psr-v4" -- start
            
            # Save PM2 configuration
            pm2 save
            
            echo "‚úÖ Deployment completed successfully!"

      - name: Deploy build files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          source: ".next,package.json,package-lock.json"
          target: /var/www/psr-v4/
          strip_components: 0
          overwrite: true

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          script: |
            echo "üîç Checking application status..."
            pm2 status psr-v4
            
            echo "üìä Recent logs:"
            pm2 logs psr-v4 --lines 20 --nostream

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment to VPS successful!"
          else
            echo "‚ùå Deployment to VPS failed!"
          fi
