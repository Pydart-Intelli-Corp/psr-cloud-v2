name: Deploy to VPS

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ðŸš€ Checkout code
        uses: actions/checkout@v4

      - name: ï¿½ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '21.x'
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build application
        run: npm run build
        env:
          NODE_ENV: production
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT || '3306' }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          NEXT_PUBLIC_API_URL: http://${{ secrets.VPS_HOST }}
          NEXT_PUBLIC_APP_URL: http://${{ secrets.VPS_HOST }}

      - name: ï¿½ðŸ“¤ Deploy files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          source: ".next/,public/,database/,config/,package.json,package-lock.json,next.config.ts,tsconfig.json,postcss.config.mjs,tailwind.config.js,instrumentation.ts,ecosystem.config.js"
          target: "/var/www/psr-v4"
          overwrite: true
          rm: false

      - name: ðŸ”§ Deploy application
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          command_timeout: 10m
          script: |
            cd /var/www/psr-v4
            
            echo "ðŸ›‘ Stopping PM2 process..."
            pm2 stop psr-v4 || true
            
            echo "ðŸ“ Creating .env.production..."
            cat > .env.production << 'EOF'
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=${{ secrets.DB_PORT || '3306' }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_SSL_CA=
            DB_REJECT_UNAUTHORIZED=false
            NODE_ENV=production
            PORT=3000
            NEXT_TELEMETRY_DISABLED=1
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
            JWT_EXPIRES_IN=1h
            JWT_REFRESH_EXPIRES_IN=7d
            SUPER_ADMIN_USERNAME=${{ secrets.SUPER_ADMIN_USERNAME || 'admin' }}
            SUPER_ADMIN_PASSWORD=${{ secrets.SUPER_ADMIN_PASSWORD || 'psr@2025' }}
            SUPER_ADMIN_EMAIL=${{ secrets.SUPER_ADMIN_EMAIL || 'admin@poornasreeequipments.com' }}
            SMTP_HOST=smtp.gmail.com
            SMTP_PORT=587
            SMTP_SECURE=false
            SMTP_USERNAME=${{ secrets.EMAIL_USER }}
            SMTP_PASSWORD=${{ secrets.EMAIL_PASSWORD }}
            EMAIL_HOST=smtp.gmail.com
            EMAIL_PORT=587
            EMAIL_SECURE=false
            EMAIL_USER=${{ secrets.EMAIL_USER }}
            EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}
            EMAIL_FROM=noreply@poornasreeequipments.com
            NEXT_PUBLIC_API_URL=http://${{ secrets.VPS_HOST }}
            NEXT_PUBLIC_APP_URL=http://${{ secrets.VPS_HOST }}
            EOF
            
            echo "ðŸ“¦ Installing production dependencies..."
            npm install --production
            
            echo "ðŸ—„ï¸ Running database migrations..."
            npx sequelize-cli db:migrate --env production || true
            npx sequelize-cli db:seed:all --env production || true
            
            echo "ðŸ” Fixing file ownership..."
            chown -R root:root /var/www/psr-v4
            
            echo "ðŸš€ Starting PM2..."
            pm2 delete psr-v4 || true
            pm2 start npm --name psr-v4 -- start
            pm2 save
            
            echo "ðŸ“Š PM2 Status:"
            pm2 status
            
            echo "âœ… Deployment complete!"
