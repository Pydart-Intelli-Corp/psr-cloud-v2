name: Deploy to VPS (Production)

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: üì¶ Checkout Repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: '21.x'
          cache: 'npm'

      - name: üì• Install Dependencies
        run: npm ci --prefer-offline

      - name: üî® Build Production Application
        run: npm run build
        env:
          NODE_ENV: production

      - name: üì¶ Create Optimized Deployment Package
        run: |
          echo "Creating deployment package..."
          mkdir -p deploy
          
          # Copy only essential production files
          cp -r .next deploy/
          cp -r public deploy/
          cp -r database deploy/
          cp -r config deploy/
          cp package.json package-lock.json deploy/
          cp next.config.ts postcss.config.mjs tailwind.config.js instrumentation.ts ecosystem.config.js deploy/
          
          # Create compressed archive
          tar -czf deploy.tar.gz -C deploy .
          
          echo "‚úÖ Package created: $(du -h deploy.tar.gz | cut -f1)"

      - name: üì§ Upload Deployment Package to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          source: "deploy.tar.gz"
          target: "/root/"
          overwrite: true

      - name: üöÄ Deploy to Production VPS
        uses: appleboy/ssh-action@v1.0.0
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
          SUPER_ADMIN_USERNAME: ${{ secrets.SUPER_ADMIN_USERNAME }}
          SUPER_ADMIN_PASSWORD: ${{ secrets.SUPER_ADMIN_PASSWORD }}
          SUPER_ADMIN_EMAIL: ${{ secrets.SUPER_ADMIN_EMAIL }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          envs: EMAIL_USER,EMAIL_PASSWORD,DB_HOST,DB_PORT,DB_USER,DB_PASSWORD,DB_NAME,JWT_SECRET,JWT_REFRESH_SECRET,SUPER_ADMIN_USERNAME,SUPER_ADMIN_PASSWORD,SUPER_ADMIN_EMAIL
          script_stop: true
          command_timeout: 20m
          script: |
            set -e
            
            echo "üéØ Starting Professional Deployment Process..."
            echo "================================================"
            
            # Step 1: Stop Application & Free Memory
            echo "üõë Stopping existing application..."
            pm2 stop psr-v4 2>/dev/null || echo "No running app found"
            pm2 delete psr-v4 2>/dev/null || echo "No PM2 process to delete"
            
            echo "üíæ Freeing system memory..."
            sync
            echo 3 > /proc/sys/vm/drop_caches 2>/dev/null || echo "Cache clear skipped"
            
            # Step 2: Clean Old Deployment
            echo "üßπ Cleaning old deployment files..."
            cd /var/www/psr-v4 || exit 1
            
            # Remove all old files except logs
            find . -maxdepth 1 ! -name 'logs' ! -name '.' ! -name '..' -exec rm -rf {} + 2>/dev/null || true
            
            # Verify clean state
            echo "‚úÖ Directory cleaned. Current size: $(du -sh . | cut -f1)"
            
            # Step 3: Extract New Build
            echo "üì¶ Extracting deployment..."
            tar -xzf /root/deploy.tar.gz -C /var/www/psr-v4
            rm -f /root/deploy.tar.gz
            
            echo "‚úÖ Files extracted successfully"
            
            # Step 4: Install Dependencies (including Next.js runtime)
            echo "üì¶ Installing dependencies..."
            npm install --prefer-offline --no-audit --no-fund
            
            # Step 5: Configure Environment
            echo "‚öôÔ∏è Creating production environment..."
            cat > .env.production << ENV_EOF
DB_HOST=${DB_HOST}
DB_PORT=${DB_PORT}
DB_USER=${DB_USER}
DB_PASSWORD=${DB_PASSWORD}
DB_NAME=${DB_NAME}
DB_SSL_CA=
DB_REJECT_UNAUTHORIZED=false
NODE_ENV=production
PORT=3000
NEXT_TELEMETRY_DISABLED=1
JWT_SECRET=${JWT_SECRET}
JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
JWT_EXPIRES_IN=1h
JWT_REFRESH_EXPIRES_IN=7d
SUPER_ADMIN_USERNAME=${SUPER_ADMIN_USERNAME}
SUPER_ADMIN_PASSWORD=${SUPER_ADMIN_PASSWORD}
SUPER_ADMIN_EMAIL=${SUPER_ADMIN_EMAIL}
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USERNAME=${EMAIL_USER}
SMTP_PASSWORD=${EMAIL_PASSWORD}
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_SECURE=false
EMAIL_USER=${EMAIL_USER}
EMAIL_PASSWORD=${EMAIL_PASSWORD}
EMAIL_FROM=noreply@poornasreeequipments.com
NEXT_PUBLIC_API_URL=https://v4.poornasreecloud.com
NEXT_PUBLIC_APP_URL=https://v4.poornasreecloud.com
ENV_EOF
            
            echo "‚úÖ Environment configured"
            
            # Step 6: Set Permissions
            echo "üîê Setting correct permissions..."
            chown -R root:root /var/www/psr-v4
            chmod -R 755 /var/www/psr-v4
            
            # Step 7: Start Application with PM2
            echo "üöÄ Starting application..."
            pm2 start ecosystem.config.js --only psr-v4
            pm2 save --force
            
            # Step 8: Health Verification
            echo "‚è≥ Waiting for Next.js to fully initialize..."
            sleep 15
            
            echo "üìä Application Status:"
            pm2 status
            
            echo ""
            echo "üîç Recent Application Logs:"
            pm2 logs psr-v4 --lines 15 --nostream
            
            echo ""
            echo "üåê Testing Application Health..."
            
            # Try multiple times with longer timeout
            RETRY=0
            MAX_RETRY=5
            while [ $RETRY -lt $MAX_RETRY ]; do
              if curl -f -m 10 http://localhost:3000 2>/dev/null; then
                echo "‚úÖ Health check PASSED"
                break
              else
                RETRY=$((RETRY+1))
                if [ $RETRY -lt $MAX_RETRY ]; then
                  echo "‚è≥ Retry $RETRY/$MAX_RETRY..."
                  sleep 3
                else
                  echo "‚ö†Ô∏è Health check FAILED after $MAX_RETRY attempts"
                fi
              fi
            done
            
            echo ""
            echo "================================================"
            echo "‚úÖ DEPLOYMENT COMPLETED SUCCESSFULLY!"
            echo "üåç Application: https://v4.poornasreecloud.com"
            echo "‚è∞ Deployed at: $(date)"
            echo "================================================"

      - name: ‚úÖ Deployment Summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment completed successfully!"
            echo "üåç Live at: https://v4.poornasreecloud.com"
          else
            echo "‚ùå Deployment failed. Check logs above."
          fi
