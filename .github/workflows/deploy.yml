name: Deploy to VPS

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: '21.x'
          cache: 'npm'

      - name: ğŸ“¥ Install Dependencies (Production Only)
        run: npm ci --prefer-offline --omit=dev --no-audit --no-fund

      - name: ğŸ”¨ Build Production Application
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1

      - name: ğŸ“¦ Create Deployment Package
        run: |
          echo "ğŸ¯ Creating deployment package..."
          mkdir -p deploy
          
          # Copy essential production files
          cp -r .next deploy/
          cp -r public deploy/
          cp -r database deploy/
          cp -r config deploy/
          cp package.json package-lock.json deploy/
          cp next.config.ts instrumentation.ts ecosystem.config.js deploy/
          cp postcss.config.mjs tailwind.config.js deploy/ 2>/dev/null || true
          
          # Create compressed archive
          tar -czf deploy.tar.gz -C deploy .
          
          PACKAGE_SIZE=$(du -h deploy.tar.gz | cut -f1)
          echo "âœ… Package created: $PACKAGE_SIZE"
          ls -lh deploy.tar.gz

      - name: ğŸ“¤ Upload to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          source: "deploy.tar.gz"
          target: "/root/"
          overwrite: true
          timeout: 60s
          command_timeout: 10m

      - name: ğŸš€ Deploy on VPS
        uses: appleboy/ssh-action@v1.0.0
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
          SUPER_ADMIN_USERNAME: ${{ secrets.SUPER_ADMIN_USERNAME }}
          SUPER_ADMIN_PASSWORD: ${{ secrets.SUPER_ADMIN_PASSWORD }}
          SUPER_ADMIN_EMAIL: ${{ secrets.SUPER_ADMIN_EMAIL }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          timeout: 60s
          envs: EMAIL_USER,EMAIL_PASSWORD,DB_HOST,DB_PORT,DB_USER,DB_PASSWORD,DB_NAME,JWT_SECRET,JWT_REFRESH_SECRET,SUPER_ADMIN_USERNAME,SUPER_ADMIN_PASSWORD,SUPER_ADMIN_EMAIL
          command_timeout: 15m
          script: |
            set -e
            echo "ğŸš€ Starting Deployment"
            echo "================================================"
            
            # Free memory aggressively
            echo "ğŸ§¹ Clearing memory..."
            sync
            echo 3 > /proc/sys/vm/drop_caches
            
            # Kill any lingering processes
            pkill -9 linuxsys 2>/dev/null || true
            pkill -9 node 2>/dev/null || true
            sleep 2
            
            # Show memory before
            echo "ğŸ’¾ Memory before cleanup:"
            free -h | head -2
            
            # Stop current application
            echo "ğŸ›‘ Stopping application..."
            pm2 stop psr-v4 2>/dev/null || true
            pm2 delete psr-v4 2>/dev/null || true
            pm2 kill 2>/dev/null || true
            sleep 2
            
            # Backup logs only
            echo "ğŸ“¦ Backing up logs..."
            mkdir -p /tmp/psr-logs-backup
            [ -d "/var/www/psr-v4/logs" ] && cp -r /var/www/psr-v4/logs/* /tmp/psr-logs-backup/ 2>/dev/null || true
            
            # Clean directory efficiently (avoid rm -rf spike)
            echo "ğŸ§¹ Cleaning deployment directory..."
            cd /var/www/psr-v4 2>/dev/null && find . -mindepth 1 -delete 2>/dev/null || true
            cd $HOME
            mkdir -p /var/www/psr-v4
            
            # Extract new build
            echo "ğŸ“¦ Extracting application..."
            tar -xzf $HOME/deploy.tar.gz -C /var/www/psr-v4
            rm -f $HOME/deploy.tar.gz
            
            # Clear cache after extraction
            sync
            echo 1 > /proc/sys/vm/drop_caches
            
            # Restore logs
            mkdir -p /var/www/psr-v4/logs
            [ -d "/tmp/psr-logs-backup" ] && mv /tmp/psr-logs-backup/* /var/www/psr-v4/logs/ 2>/dev/null || true
            rm -rf /tmp/psr-logs-backup
            
            cd /var/www/psr-v4
            
            # Install dependencies
            echo "ğŸ“¦ Installing dependencies..."
            NODE_ENV=production npm ci --prefer-offline --omit=dev --no-audit --no-fund --loglevel=error
            
            # Create environment file
            echo "âš™ï¸ Configuring environment..."
            cat > .env.production << EOF
            DB_HOST=${DB_HOST}
            DB_PORT=${DB_PORT}
            DB_USER=${DB_USER}
            DB_PASSWORD=${DB_PASSWORD}
            DB_NAME=${DB_NAME}
            DB_SSL_CA=
            DB_REJECT_UNAUTHORIZED=false
            NODE_ENV=production
            PORT=3000
            NEXT_TELEMETRY_DISABLED=1
            JWT_SECRET=${JWT_SECRET}
            JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
            JWT_EXPIRES_IN=1h
            JWT_REFRESH_EXPIRES_IN=7d
            SUPER_ADMIN_USERNAME=${SUPER_ADMIN_USERNAME}
            SUPER_ADMIN_PASSWORD=${SUPER_ADMIN_PASSWORD}
            SUPER_ADMIN_EMAIL=${SUPER_ADMIN_EMAIL}
            SMTP_HOST=smtp.gmail.com
            SMTP_PORT=587
            SMTP_SECURE=false
            SMTP_USERNAME=${EMAIL_USER}
            SMTP_PASSWORD=${EMAIL_PASSWORD}
            EMAIL_HOST=smtp.gmail.com
            EMAIL_PORT=587
            EMAIL_SECURE=false
            EMAIL_USER=${EMAIL_USER}
            EMAIL_PASSWORD=${EMAIL_PASSWORD}
            EMAIL_FROM=noreply@poornasreeequipments.com
            NEXT_PUBLIC_API_URL=https://v4.poornasreecloud.com
            NEXT_PUBLIC_APP_URL=https://v4.poornasreecloud.com
            EOF
            
            chmod 600 .env.production
            
            # Start application
            echo "ğŸš€ Starting application..."
            pm2 start ecosystem.config.js --only psr-v4 --update-env
            pm2 save
            
            # Health check
            echo "â³ Waiting for application startup..."
            sleep 10
            
            # Verify application is running
            if curl -sf http://localhost:3000 > /dev/null; then
              echo "âœ… Application is responding!"
            else
              echo "âš ï¸ Application may not be responding yet"
            fi
            
            # Show status
            echo ""
            echo "ğŸ“Š PM2 Status:"
            pm2 status
            echo ""
            echo "ğŸ’¾ Memory Status:"
            free -h | head -2
            echo ""
            echo "================================================"
            echo "âœ… DEPLOYMENT COMPLETED SUCCESSFULLY!"
            echo "ğŸŒ Application: https://v4.poornasreecloud.com"
            echo "================================================"

      - name: âœ… Deployment Summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ Deployment completed successfully!"
            echo "ğŸŒ Live at: https://v4.poornasreecloud.com"
          else
            echo "âŒ Deployment failed. Check logs above."
            exit 1
          fi
