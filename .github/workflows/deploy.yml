name: Deploy to VPS

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: üì¶ Checkout Repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: '21.x'
          cache: 'npm'

      - name: üì• Install Dependencies (Production Only)
        run: npm ci --prefer-offline --omit=dev --no-audit --no-fund

      - name: üî® Build Production Application
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1

      - name: üì¶ Create Ultra-Optimized Deployment Package
        run: |
          echo "üéØ Creating minimal deployment package..."
          mkdir -p deploy
          
          # Copy ONLY essential production files
          echo "üìÅ Copying .next build output..."
          cp -r .next deploy/
          
          echo "üìÅ Copying public assets..."
          cp -r public deploy/
          
          echo "üìÅ Copying database migrations..."
          cp -r database deploy/
          
          echo "üìÅ Copying configuration files..."
          cp -r config deploy/
          
          echo "üìÅ Copying package files..."
          cp package.json package-lock.json deploy/
          
          echo "üìÅ Copying config files..."
          cp next.config.ts instrumentation.ts ecosystem.config.js deploy/
          cp postcss.config.mjs tailwind.config.js deploy/ 2>/dev/null || true
          
          # Create highly compressed archive with pigz (parallel gzip) if available
          echo "üóúÔ∏è Compressing deployment package..."
          if command -v pigz &> /dev/null; then
            tar -I pigz -cf deploy.tar.gz -C deploy .
          else
            tar -czf deploy.tar.gz -C deploy .
          fi
          
          PACKAGE_SIZE=$(du -h deploy.tar.gz | cut -f1)
          echo "‚úÖ Deployment package created: $PACKAGE_SIZE"
          ls -lh deploy.tar.gz

      - name: üßπ Pre-deployment Cleanup (Free Memory)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          timeout: 60s
          command_timeout: 5m
          script: |
            echo "üßπ Pre-upload cleanup..."
            
            # Kill suspicious processes first
            echo "üî™ Killing suspicious processes..."
            pkill -9 linuxsys 2>/dev/null || true
            pkill -9 xmrig 2>/dev/null || true
            sleep 1
            
            # Stop PM2 gracefully
            echo "üõë Stopping PM2..."
            pm2 stop all 2>/dev/null || true
            pm2 delete all 2>/dev/null || true
            pm2 kill 2>/dev/null || true
            sleep 1
            
            # Sync and clear caches
            echo "üíæ Clearing caches..."
            sync
            echo 3 > /proc/sys/vm/drop_caches 2>/dev/null || true
            
            # Remove old files
            rm -f /root/deploy.tar.gz
            
            echo "‚úÖ Pre-cleanup complete"
            free -h

      - name: üì§ Upload Deployment Package to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          source: "deploy.tar.gz"
          target: "/root/"
          overwrite: true
          strip_components: 0
          timeout: 60s
          command_timeout: 10m
          debug: true

      - name: üöÄ Deploy to Production VPS (Memory Optimized)
        uses: appleboy/ssh-action@v1.0.0
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
          SUPER_ADMIN_USERNAME: ${{ secrets.SUPER_ADMIN_USERNAME }}
          SUPER_ADMIN_PASSWORD: ${{ secrets.SUPER_ADMIN_PASSWORD }}
          SUPER_ADMIN_EMAIL: ${{ secrets.SUPER_ADMIN_EMAIL }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          timeout: 60s
          envs: EMAIL_USER,EMAIL_PASSWORD,DB_HOST,DB_PORT,DB_USER,DB_PASSWORD,DB_NAME,JWT_SECRET,JWT_REFRESH_SECRET,SUPER_ADMIN_USERNAME,SUPER_ADMIN_PASSWORD,SUPER_ADMIN_EMAIL
          script_stop: true
          command_timeout: 15m
          script: |
            echo "üöÄ ULTRA-FAST DEPLOYMENT PROCESS"
            echo "================================================"
            
            # ============================================
            # STEP 0: ENABLE SWAP (FIRST PRIORITY)
            # ============================================
            echo "üíæ Checking swap space..."
            
            # Check if swap is already active
            if swapon --show | grep -q "/swapfile"; then
              echo "‚úÖ Swap already active"
            elif [ -f /swapfile ]; then
              echo "‚ö†Ô∏è Swap file exists but not active. Activating..."
              swapon /swapfile || true
            else
              echo "‚ö†Ô∏è No swap detected. Creating 4GB swap file..."
              df -h /
              fallocate -l 4G /swapfile || dd if=/dev/zero of=/swapfile bs=1M count=4096
              chmod 600 /swapfile
              mkswap /swapfile
              swapon /swapfile
              echo "‚úÖ Swap created and enabled"
            fi
            
            free -h

            # ============================================
            # STEP 1: CLEAR MEMORY & STOP APPLICATION
            # ============================================
            echo "üßπ Clearing system memory and caches..."
            
            # Kill high memory consuming processes (excluding critical ones)
            echo "üî™ Killing high memory processes..."
            pkill -f linuxsys 2>/dev/null || true
            pkill -f cryptominer 2>/dev/null || true
            pkill -f xmrig 2>/dev/null || true
            sleep 1
            
            # Stop all running applications
            pm2 stop all 2>/dev/null || true
            pm2 delete all 2>/dev/null || true
            
            # Kill PM2 daemon to free maximum memory
            pkill -9 PM2 2>/dev/null || true
            
            sleep 2
            
            # Clear PageCache, dentries, and inodes
            sync
            echo 3 > /proc/sys/vm/drop_caches 2>/dev/null || sudo sh -c 'echo 3 > /proc/sys/vm/drop_caches' || true
            
            # Show memory before cleanup
            echo "üíæ Memory status:"
            free -h
            
            echo "‚úÖ Memory cleared, processes stopped"

            # ============================================
            # STEP 2: CLEANUP (Move & Recreate Strategy)
            # ============================================
            echo "üóëÔ∏è Preparing directory..."
            
            # Ensure target directory exists
            if [ -d "/var/www/psr-v4" ]; then
              echo "üì¶ Backing up logs and moving old app..."
              
              # 1. Preserve logs
              mkdir -p /tmp/psr-logs-backup
              if [ -d "/var/www/psr-v4/logs" ]; then
                mv /var/www/psr-v4/logs/* /tmp/psr-logs-backup/ 2>/dev/null || true
              fi
              
              # 2. Move old application out of the way (Instant)
              # We move it to a temp folder to delete later
              rm -rf /tmp/psr-v4-old 2>/dev/null || true
              mv /var/www/psr-v4 /tmp/psr-v4-old
            fi
            
            # 3. Create fresh directory
            mkdir -p /var/www/psr-v4
            
            # 4. Restore logs
            mkdir -p /var/www/psr-v4/logs
            mv /tmp/psr-logs-backup/* /var/www/psr-v4/logs/ 2>/dev/null || true
            rmdir /tmp/psr-logs-backup 2>/dev/null || true
            
            echo "‚úÖ Directory prepared (Old app moved to /tmp/psr-v4-old)"
            
            # ============================================
            # STEP 3: EXTRACT NEW BUILD (FAST)
            # ============================================
            echo "üì¶ Extracting deployment package..."
            
            # Debug: Check file existence and size
            if [ -f "/root/deploy.tar.gz" ]; then
              echo "‚úÖ Found package at /root/deploy.tar.gz"
              ls -lh /root/deploy.tar.gz
            else
              echo "‚ùå Package NOT found at /root/deploy.tar.gz"
              echo "üìÇ Listing /root/:"
              ls -la /root/
              exit 1
            fi
            
            # Extract using standard tar (more reliable for debugging)
            tar -xzf /root/deploy.tar.gz -C /var/www/psr-v4
            
            rm -f /root/deploy.tar.gz
            echo "‚úÖ Files extracted"
            
            # ============================================
            # STEP 4: INSTALL DEPENDENCIES (PRODUCTION ONLY)
            # ============================================
            echo "üì¶ Installing production dependencies..."
            
            # Use npm ci for clean install (faster than npm install)
            NODE_ENV=production npm ci --prefer-offline --omit=dev --no-audit --no-fund --loglevel=error
            
            echo "‚úÖ Dependencies installed"
            
            # ============================================
            # STEP 5: CONFIGURE ENVIRONMENT (FAST)
            # ============================================
            echo "‚öôÔ∏è Creating environment configuration..."
            
            cat > .env.production << 'ENV_EOF'
            DB_HOST=${DB_HOST}
            DB_PORT=${DB_PORT}
            DB_USER=${DB_USER}
            DB_PASSWORD=${DB_PASSWORD}
            DB_NAME=${DB_NAME}
            DB_SSL_CA=
            DB_REJECT_UNAUTHORIZED=false
            NODE_ENV=production
            PORT=3000
            NEXT_TELEMETRY_DISABLED=1
            JWT_SECRET=${JWT_SECRET}
            JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
            JWT_EXPIRES_IN=1h
            JWT_REFRESH_EXPIRES_IN=7d
            SUPER_ADMIN_USERNAME=${SUPER_ADMIN_USERNAME}
            SUPER_ADMIN_PASSWORD=${SUPER_ADMIN_PASSWORD}
            SUPER_ADMIN_EMAIL=${SUPER_ADMIN_EMAIL}
            SMTP_HOST=smtp.gmail.com
            SMTP_PORT=587
            SMTP_SECURE=false
            SMTP_USERNAME=${EMAIL_USER}
            SMTP_PASSWORD=${EMAIL_PASSWORD}
            EMAIL_HOST=smtp.gmail.com
            EMAIL_PORT=587
            EMAIL_SECURE=false
            EMAIL_USER=${EMAIL_USER}
            EMAIL_PASSWORD=${EMAIL_PASSWORD}
            EMAIL_FROM=noreply@poornasreeequipments.com
            NEXT_PUBLIC_API_URL=https://v4.poornasreecloud.com
            NEXT_PUBLIC_APP_URL=https://v4.poornasreecloud.com
            ENV_EOF
            
            # Remove indentation from .env.production
            sed -i 's/^[ \t]*//' .env.production
            
            # Expand variables in .env.production
            echo "üîÑ Expanding variables..."
            temp_env=$(mktemp)
            while IFS= read -r line || [ -n "$line" ]; do
              eval echo \""$line"\" >> "$temp_env"
            done < .env.production
            mv "$temp_env" .env.production
            
            echo "‚úÖ Environment configured"
            
            # ============================================
            # STEP 6: SET PERMISSIONS (FAST)
            # ============================================
            echo "üîê Setting permissions..."
            chown -R root:root . 2>/dev/null || true
            chmod -R 755 . 2>/dev/null || true
            
            # ============================================
            # STEP 7: START APPLICATION (PM2)
            # ============================================
            echo "üöÄ Starting application with PM2..."
            
            # Start only the main app (not pulse-scheduler yet)
            pm2 start ecosystem.config.js --only psr-v4 --update-env
            pm2 save --force
            
            # ============================================
            # STEP 8: HEALTH CHECK
            # ============================================
            echo "‚è≥ Waiting for application startup..."
            sleep 8
            
            # Quick health check with retries
            RETRY=0
            MAX_RETRY=3
            
            while [ $RETRY -lt $MAX_RETRY ]; do
              if curl -sf -m 5 http://localhost:3000 > /dev/null 2>&1; then
                echo "‚úÖ Application is responding!"
                break
              else
                RETRY=$((RETRY+1))
                if [ $RETRY -lt $MAX_RETRY ]; then
                  echo "‚è≥ Retry $RETRY/$MAX_RETRY..."
                  sleep 3
                fi
              fi
            done
            
            # ============================================
            # STEP 9: STATUS REPORT
            # ============================================
            echo ""
            echo "üìä PM2 Status:"
            pm2 status
            
            echo ""
            echo "üíæ Final Memory Status:"
            free -h | head -2
            
            # Clean up the old app in background (low priority)
            echo "üßπ Cleaning up old files in background..."
            (ionice -c 3 rm -rf /tmp/psr-v4-old &) 2>/dev/null || rm -rf /tmp/psr-v4-old &
            
            echo ""
            echo "================================================"
            echo "‚úÖ DEPLOYMENT COMPLETED SUCCESSFULLY!"
            echo "üåç Application: https://v4.poornasreecloud.com"
            echo "‚è∞ Deployed at: $(date +'%Y-%m-%d %H:%M:%S %Z')"
            echo "‚ö° Fast deployment with memory optimization"
            echo "================================================"

      - name: ‚úÖ Deployment Summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "üéâ Deployment completed successfully!"
            echo "üåç Live at: https://v4.poornasreecloud.com"
            echo "‚ö° Optimized for speed and memory efficiency"
          else
            echo "‚ùå Deployment failed. Check logs above."
            exit 1
          fi
